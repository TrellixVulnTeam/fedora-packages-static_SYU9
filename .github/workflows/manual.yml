name: Manual trigger to build and upload to pages

on:
  # Runs when manually triggered using the UI or API.
  workflow_dispatch:

jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-20.04
    # Run the job in container
    container: ubuntu:21.04

    steps:
    - name: Install Homebrew for Ubuntu 21.04
      run: |
        set -x
        apt-get -y update
        apt-get -y install --no-install-recommends curl ca-certificates git
        curl -fsSLo /tmp/install.sh https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh
        /bin/bash /tmp/install.sh

        # Add `brew` to PATH
        # https://docs.github.com/en/actions/learn-github-actions/workflow-commands-for-github-actions#adding-a-system-path
        echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
        # Set other `brew` vars to fix bottle installation problem
        # https://github.com/Homebrew/discussions/discussions/2713
        /home/linuxbrew/.linuxbrew/bin/brew shellenv
        echo "HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew" >> $GITHUB_ENV
        echo "HOMEBREW_CELLAR=/home/linuxbrew/.linuxbrew/Cellar" >> $GITHUB_ENV
        echo "HOMEBREW_REPOSITORY=/home/linuxbrew/.linuxbrew/Homebrew" >> $GITHUB_ENV

    - name: Disk space utils
      run: |
        brew config

        brew install duf
        brew install dust
        brew install abitrolly/tap/tdu
        duf

    - name: Free space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        dust /

    - name: Checkout
      uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        apt-get -y install $(grep "^[^#]" dependencies.txt)

    - name: Build
      env:
        SITEMAP_URL: https://abitrolly.github.io/fedora-packages-static/
      run: |
        make all
        duf
        tdu -human

    - name: Upload to GitHub Pages
      uses: crazy-max/ghaction-github-pages@v2.5.0
      with:
        # Git branch where assets will be deployed
        #target_branch: # optional, default is gh-pages
        # Create incremental commit instead of doing push force
        keep_history: true # optional, default is false
        # Allow an empty commit to be created
        #allow_empty_commit: # optional, default is true
        # Build directory to deploy
        build_dir: public_html
        # The committer name and email address
        #committer: # optional
        # The author name and email address
        #author: # optional
        # Commit message
        #commit_message: # optional
        # Write the given domain name to the CNAME file
        #fqdn: # optional
        # Allow Jekyll to build your site
        jekyll: false # optional, default is true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
